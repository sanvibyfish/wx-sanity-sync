# 功能需求：微信公众号文章同步至 Sanity

## 1. 核心目标

实现一个自动化脚本，能够将微信公众号内的历史文章“一键式”拉取，并将其内容转换、写入到 Sanity CMS 中。该脚本还应支持后续的增量同步。

## 2. 前提条件

1.  **永久图文素材**：所有需要迁移的文章必须已经保存为微信公众号后台的“永久图文素材”。
2.  **IP 白名单**：执行脚本的服务器公网 IP 地址必须被添加到公众号的“IP 白名单”中。

## 3. 核心迁移流程

| 步骤 | 接口 / 工具 | 说明 |
| :--- | :--- | :--- |
| 1. 获取 `access_token` | `/cgi-bin/token` | 使用 AppID 和 AppSecret 换取有效期为 2 小时的 `access_token`。 |
| 2. 查询素材总数 | `/cgi-bin/material/get_materialcount` | 获取永久图文素材的总量，用于计算分页次数。 |
| 3. 分页拉取列表 | `/cgi-bin/material/batchget_material` | 每次最多拉取 20 篇，获取其 `media_id` 列表。 |
| 4. 拉取正文 | `/cgi-bin/material/get_material` | 使用 `media_id` 获取文章的详细内容，主要是 HTML 格式的正文。 |
| 5. 处理图片 | 自定义脚本 | 下载文章内嵌的微信图片，上传至 Sanity 的资源库，并替换原 HTML 中的图片链接。 |
| 6. HTML 转换 | `@sanity/block-tools` | 将清洗后的 HTML 转换为 Sanity 的 Portable Text 格式。 |
| 7. 写入 Sanity | `@sanity/client` | 使用 `createOrReplace` 方法，以 `wx-[media_id]` 作为唯一 `_id`，将文章数据写入 Sanity。 |

## 4. 增量同步机制

-   **新增文章**：对于新发布的文章，在群发时勾选“保存为永久图文素材”，脚本再次运行时即可自动获取。
-   **修改文章**：通过比较微信 `get_material` 接口返回的 `update_time` 和 Sanity 中已存文章的 `publishedAt` 或 `updatedAt` 字段，判断是否需要覆盖更新。

## 5. 速率与并发

-   微信素材接口调用速率限制为每分钟 1,000 次，足以满足需求。
-   建议采用 5-10 个并发任务来加速数据迁移过程。

## 6. 兜底方案

在以下情况，仍需考虑使用传统爬虫作为补充方案：
-   历史文章未保存为永久素材，且无法通过后台导入。
-   需要同步留言、阅读量等官方素材接口无法提供的数据。
-   公众号为个人订阅号，永久素材上限仅 500 条。
